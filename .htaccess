# Survey Platform .htaccess Configuration

# Directory index
DirectoryIndex index.php index.html

# Enable URL rewriting
RewriteEngine On

# Security Headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"

# Block access to sensitive files and directories
<Files ~ "\.(env|log|ini|conf|sql|bak|backup|old|tmp)$">
    Order Allow,Deny
    Deny from all
</Files>

# Block access to core directories
<Directory "core">
    Order Allow,Deny
    Deny from all
</Directory>

<Directory "templates">
    Order Allow,Deny
    Deny from all
</Directory>

# Block access to hidden files (except .htaccess)
<FilesMatch "^\..+$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

<Files ".htaccess">
    Order Allow,Deny
    Allow from all
</Files>

# Survey URL Rewriting
# /Survey/abc123def456 -> /Survey.php?id=abc123def456
RewriteRule ^Survey/([a-zA-Z0-9]{16})/?$ Survey.php?id=$1 [L,QSA]

# Admin URL Rewriting
# /admin/ -> /admin/index.php
RewriteRule ^admin/?$ admin/index.php [L,QSA]
RewriteRule ^admin/([a-zA-Z0-9_-]+)/?$ admin/$1.php [L,QSA]

# Creator URL Rewriting
# /creator/ -> /creator/index.php
RewriteRule ^creator/?$ creator/index.php [L,QSA]
RewriteRule ^creator/([a-zA-Z0-9_-]+)/?$ creator/$1.php [L,QSA]

# API endpoint (already exists as api.php)
RewriteRule ^api/?$ api.php [L,QSA]

# Static pages
RewriteRule ^(about|features|pricing|help|contact|privacy|terms|cookies)/?$ pages/$1.php [L,QSA]

# Main pages
RewriteRule ^/?$ index.php [L,QSA]

# Error page handling - Use relative paths for subdirectory compatibility
ErrorDocument 403 error-pages/403.php
ErrorDocument 404 error-pages/404.php  
ErrorDocument 500 error-pages/500.php

# Cache Control for static assets
<LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    Header append Cache-Control "public, immutable"
</LocationMatch>

# Gzip Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Prevent hotlinking
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://localhost [NC]
RewriteCond %{HTTP_REFERER} !^https?://127\.0\.0\.1 [NC]
RewriteCond %{HTTP_REFERER} !^https?://.*\.mohman\.ir [NC]
RewriteRule \.(jpg|jpeg|png|gif|svg|css|js)$ - [F]

# Security: Disable server signature
ServerSignature Off

# Security: Hide PHP version
<IfModule mod_headers.c>
    Header unset X-Powered-By
</IfModule>

# Limit file upload size (adjust as needed)
LimitRequestBody 10485760  # 10MB

# Directory index
DirectoryIndex index.php index.html

# PHP Configuration (if allowed) - Updated for common hosting environments
<IfModule mod_php.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_value session.cookie_httponly 1
    php_value session.use_strict_mode 1
    php_value max_execution_time 30
    php_value memory_limit 128M
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
</IfModule>

# Content Security Policy (adjust as needed)
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://fonts.googleapis.com https://fonts.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'none';"

# Rate limiting (if mod_evasive is available)
<IfModule mod_evasive24.c>
    DOSHashTableSize    1024
    DOSPageCount        2
    DOSPageInterval     1
    DOSSiteCount        50
    DOSSiteInterval     1
    DOSBlockingPeriod   600
</IfModule>

# Additional security measures
Options -Indexes -ExecCGI -Includes
Options +FollowSymLinks

# Disable access to backup files
<FilesMatch "\.(bak|backup|old|tmp|~)$">
    Require all denied
</FilesMatch>

# Block common attack patterns
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|[|%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|[|%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} proc/self/environ [OR]
    RewriteCond %{QUERY_STRING} mosConfig_[a-zA-Z_]{1,21}(=|%3D) [OR]
    RewriteCond %{QUERY_STRING} base64_(en|de)code[^(]*\([^)]*\) [OR]
    RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*iframe.*(>|%3E) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>
